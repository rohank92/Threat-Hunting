sections:
  section-1763390001473-0:
    description: 'Each widget provides a query that can be leveraged to hunt for potentially
      suspicious process activity. Apply allowlisting as necessary '
    collapsed: false
    timeSelector:
      end: now
      start: 1d
    widgetIds:
    - 168e8d8b-fefd-48da-b819-660e67b0494e
    - 6b3a890e-250a-4b39-b637-e797713733af
    - f5ffd08f-b4fe-43e9-ae5b-b25eed25a0ea
    - 3d05ede7-7316-43a1-ac4d-9da73d6fcb62
    - 317ed991-cd35-44a3-b37d-e717fbae3565
    - 11dcff34-2d4e-41ad-8605-efc360fb1c3e
    - 730d1ccf-331a-44f9-b195-99944ab8a3be
    - 5fad59b9-e2bb-408c-a892-4445de3ca277
    - a079cbf1-cc6e-4606-bf82-843f381b0cb6
    - 99ea0b55-e354-432e-ab34-53b509acfc42
    order: 0
    title: Process Behavior (PB01 - PB10)
  section-1763390589472-1:
    collapsed: false
    order: 1
    title: Credential access and Lateral Movement (CLM01-04)
    widgetIds:
    - 089fc530-955f-4aff-93d0-22550af9e0f1
    - 08129b94-9682-4bb7-a0d1-cea0191622e5
    - 94ee5ce9-45fe-468f-9ffb-04b95d7e8ce4
    - 78bcc091-b872-458d-8a95-87a96d1119c5
name: 'Threat hunting queries - Linux '
updateFrequency: never
timeSelector: {}
sharedTimeInterval:
  enabled: false
  isLive: false
  start: 1d
widgets:
  5fad59b9-e2bb-408c-a892-4445de3ca277:
    x: 0
    y: 28
    height: 4
    queryString: |
      //PB08 - Debugger/Tracer usage (gdb/strace/ltrace)
      /*
      Notes on certain commandlines:
      1. /usr/libexec/abrt-gdb-exploitable refers to a Python script used by ABRT (Automatic Bug Reporting Tool) in conjunction with GDB (GNU Debugger). This script is not a standalone executable in the traditional sense but rather a Python module designed to be loaded and executed within a GDB session. The primary purpose of abrt-gdb-exploitable is to assess the "exploitability" of a crash or vulnerability identified by ABRT. It leverages the exploitable GDB plugin, which employs heuristics to analyze the application's state at the time of a crash and classify the potential for exploitation. This classification helps developers prioritize bug fixes based on the security implications of a crash.
      */
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | ImageFileName = /(gdb$|strace|ltrace)/i
      | groupby([ComputerName], function=[last_seen:=max(@timestamp), collect(ParentBaseFileName, CommandLine , ImageFileName, FilePath)], limit=200)
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB08 - Debugger/Tracer usage (gdb/strace/ltrace)
    isLive: false
    type: query
  317ed991-cd35-44a3-b37d-e717fbae3565:
    x: 0
    y: 16
    height: 4
    queryString: |
      //PB05 - Unusual interpreters (perl, lua, awk, tcl, expect)"
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | ImageFileName = /(perl|lua|awk|tcl|expect)/i
      | groupby([aid, ComputerName , ParentBaseFileName, ImageFileName, FilePath, CommandLine], function=[last_seen:=max(@timestamp)])
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 15m
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB05 - Unusual interpreters (perl, lua, awk, tcl, expect)
    isLive: false
    type: query
  730d1ccf-331a-44f9-b195-99944ab8a3be:
    x: 0
    y: 24
    height: 4
    queryString: |
      // PB07 - LD_PRELOAD / LD_LIBRARY_PATH usage
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | CommandLine = /LD_PRELOAD|LD_LIBRARY_PATH/i
      | groupby([ComputerName , ParentBaseFileName, ImageFileName, FilePath], function=[last_seen:=max(@timestamp), collect(CommandLine)], limit=200)
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB07 - LD_PRELOAD / LD_LIBRARY_PATH usage
    isLive: false
    type: query
  a079cbf1-cc6e-4606-bf82-843f381b0cb6:
    x: 0
    y: 32
    height: 4
    queryString: |
      //PB09 - systemd unit file changes (FileModification/FileCreation)
      "event_platform" = Lin
      | "#event_simpleName" = ProcessRollup2 OR "#event_simpleName" = SystemdServiceDeleted OR "#event_simpleName" = SystemdServiceCreated
      | /(\/etc\/systemd\/system\/)|(\/lib\/systemd\/system\/)/i
      | groupby([ComputerName], function=[last_seen:=max(@timestamp), collect(ParentBaseFileName, CommandLine , ImageFileName, SystemdUnitName,SystemdUnitPath)], limit=200)
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB09 - systemd unit file changes
    isLive: false
    type: query
  94ee5ce9-45fe-468f-9ffb-04b95d7e8ce4:
    x: 0
    y: 4
    height: 4
    queryString: |-
      // CLM02 - sshd_config modified
      // candidate for BAS validation.
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | FilePath = "/etc/ssh/sshd_config"
      | groupby([ComputerName], function=[last_seen:=max(@timestamp), collect(ParentBaseFileName, CommandLine , ImageFileName, FilePath, UserName)], limit=200)
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 15m
    width: 12
    options:
      columns:
      - fieldName: '@timestamp'
        format: datetime
        type: field
        width: 200
      - groupByPrefix: false
        header: Field List
        type: fieldList
      newestAtBottom: true
      showOnlyFirstLine: false
    visualization: list-view
    title: CLM02 - sshd_config modified
    isLive: false
    type: query
  78bcc091-b872-458d-8a95-87a96d1119c5:
    x: 0
    y: 0
    height: 4
    queryString: |-
      // CLM01 - New authorized_keys created/modified
      // Management scripts could make this noisy. Toggle between CommandLine and FilePath search parameters (could vary based on EDR fields / Technique)
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | CommandLine = /(\.ssh\/authorized_keys)|(\/root\/\.ssh\/authorized_keys)/i
      | groupby([ComputerName], function=[last_seen:=max(@timestamp), collect(ParentBaseFileName, CommandLine , ImageFileName, FilePath, UserName)], limit=200)
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: CLM01 - New authorized_keys created/modified
    isLive: false
    type: query
  08129b94-9682-4bb7-a0d1-cea0191622e5:
    x: 0
    y: 8
    height: 4
    queryString: |-
      //CLM03 - Logon and Logon Types (exclude RFC 1918 private IP ranges) and known Usernames
      "#event_simpleName" = "UserLogon"  "event_platform" = Lin
      | case {
        LogonType=2 | LogonType_hr := "Interactive" ;
        LogonType=3 | LogonType_hr := "Network";
        LogonType=4 | LogonType_hr := "Batch";
        LogonType=5 | LogonType_hr := "Service";
        LogonType=6 | LogonType_hr := "Proxy";
        LogonType=7 | LogonType_hr := "Unlock";
        LogonType=8 | LogonType_hr := "Network_cleartext";
        LogonType=9 | LogonType_hr := "new credentials";
        LogonType=10 | LogonType_hr := "remote interactive";
        LogonType=11 | LogonType_hr := "cahced interactive";
        LogonType=12 | LogonType_hr := "cached_remote_interactive";
        LogonType=13| LogonType_hr := "cached_unlock"
      }
      | groupby([ComputerName], function=[last_seen:=max(@timestamp), collect(UserName, source.ip, LogonType_hr)], limit=200)
      | sort(field=last_seen,  order=desc, limit=50)

      | UserName != /(venafi_deploy|tenablelnx|linux_eng|auto_eng)/i
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: 'CLM03 - Logon and Logon Types (exclude RFC 1918 private IP ranges) and
      known Usernames '
    isLive: false
    type: query
  f5ffd08f-b4fe-43e9-ae5b-b25eed25a0ea:
    x: 0
    y: 0
    height: 4
    queryString: "//\"PB01 - Suspicious execve: non-shell parent spawning shell\"\n\
      |\"#event_simpleName\" = ProcessRollup2\n\t\t\t| \"event_platform\" = Lin\n\t\
      \t\t| ParentBaseFileName != /(bash|sh|zsh|fish)/i\n\t\t\t| ImageFileName = /(bash|sh)/i\n\
      \t\t\t| groupby([aid, ParentBaseFileName, ImageFileName, CommandLine], function=[last_seen:=max(@timestamp)],\
      \ limit=2000)\n\t\t\t| sort(field=last_seen,  order=desc, limit=50)"
    end: now
    start: 15m
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: 'PB01 - suspicious execve: non-shell parent spawning shell '
    isLive: false
    type: query
  168e8d8b-fefd-48da-b819-660e67b0494e:
    x: 0
    y: 8
    height: 4
    queryString: "//PB03 - Binary masquerading (tmp/dev/shm)\n\"#event_simpleName\"\
      \ = ProcessRollup2  \"event_platform\" = Lin\n\t\t| FilePath = /\\/tmp\\/|\\\
      /var\\/tmp\\/ |\\/dev\\/shm\\/\"/i\n\t\t| groupby([aid, ParentBaseFileName,\
      \ ImageFileName, FilePath, CommandLine], function=[last_seen:=max(@timestamp)])\n\
      \t\t| sort(field=last_seen,  order=desc, limit=50)"
    end: now
    start: 15m
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB03 - Binary masquerading (tmp/dev/shm)
    isLive: false
    type: query
  3d05ede7-7316-43a1-ac4d-9da73d6fcb62:
    x: 0
    y: 12
    height: 4
    queryString: |-
      //PB04 - Fileless execution (memfd, /proc/self/fd)
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | FilePath = /memfd|(\/proc\/self\/fd)/i
      | groupby([aid, ComputerName , ParentBaseFileName, ImageFileName, FilePath, CommandLine], function=[last_seen:=max(@timestamp)])
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 15m
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB04 - Fileless execution (memfd, /proc/self/fd)
    isLive: false
    type: query
  99ea0b55-e354-432e-ab34-53b509acfc42:
    x: 0
    y: 36
    height: 4
    queryString: |-
      //PB10 - Web app / application spawning shell
      "event_platform" = Lin "#event_simpleName" = *
      | ParentBaseFileName = /(nginx|apache2|php-fpm|mod_php|node)/i
      | FileName = /(bash|sh)/i
      | user.name != /<list your known usernames here>/
      | groupby([ComputerName, ParentBaseFileName], function=[last_seen:=max(@timestamp), collect(UserName, CommandLine , ImageFileName)], limit=200)
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB10 - Web app / application spawning shell
    isLive: false
    type: query
  6b3a890e-250a-4b39-b637-e797713733af:
    x: 0
    y: 4
    height: 4
    queryString: "//\"PB02 - Service spawning shell\"\n| \"#event_simpleName\" = ProcessRollup2\n\
      \t\t\t| \"event_platform\" = Lin\n\t\t\t| ParentBaseFileName = /(systemd|nginx|httpd|apache2|sshd|php-fpm)/i\
      \ AND  ImageFileName = /(bash|sh)/i\n\t\t\t| groupby([aid, ParentBaseFileName,\
      \ ImageFileName, CommandLine], function=[last_seen:=max(@timestamp)])\n\t\t\t\
      | sort(field=last_seen,  order=desc, limit=50)"
    end: now
    start: 15m
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB02 - Service spawning shell
    isLive: false
    type: query
  089fc530-955f-4aff-93d0-22550af9e0f1:
    x: 0
    y: 12
    height: 4
    queryString: |
      //CLM04 - sudo / su escalation by unexpected user
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | FileName = /(sudo|su$)/i
      | UserName != "root"
      | groupby([ComputerName], function=[last_seen:=max(@timestamp), collect(ParentBaseFileName, CommandLine , ImageFileName, FilePath, UserName)], limit=200)
      | sort(field=last_seen,  order=desc, limit=50)
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: CLM04 - sudo / su escalation by unexpected user
    isLive: false
    type: query
  11dcff34-2d4e-41ad-8605-efc360fb1c3e:
    x: 0
    y: 20
    height: 4
    queryString: |-
      // PB06 - Abnormal sudo usage
      "#event_simpleName" = ProcessRollup2  "event_platform" = Lin
      | ImageFileName = /sudo/i
      | CommandLine != /\/usr\/bin\//i
      | groupby([ComputerName , ParentBaseFileName, ImageFileName, FilePath, CommandLine], function=[last_seen:=max(@timestamp), collect(aid)])
      | sort(field=last_seen,  order=desc, limit=50)
      | CommandLine != "/bin/sudo /etc/init.d/cohesity-agent status"
      | CommandLine != "sudo /etc/init.d/tidal status"
    end: now
    start: 7d
    width: 12
    options:
      cell-overflow: wrap-text
      configured-columns: {}
      row-numbers-enabled: false
    visualization: table-view
    title: PB06 - Abnormal sudo usage
    isLive: false
    type: query
$schema: https://schemas.humio.com/dashboard/v0.23.0
